# 埋点功能实现原理说明

## 一、埋点是如何工作的？

### 1. 当前实现状态

**开发环境（当前）：**
- ✅ 埋点服务已创建，所有事件都会在控制台打印
- ⏳ 实际上报逻辑还未实现（TODO 状态）

**生产环境（需要实现）：**
- ⏳ 需要将埋点数据发送到服务器
- ⏳ 服务器接收并存储埋点数据
- ⏳ 可以通过数据分析平台查看用户行为

### 2. 埋点流程

```
用户操作（点击按钮、进入页面等）
    ↓
调用 track() 方法
    ↓
自动补全公共字段（device_id, platform, app_version 等）
    ↓
发送到服务器（当前：只打印到控制台）
    ↓
服务器存储数据
    ↓
数据分析平台展示
```

## 二、如何让生产环境也能上报埋点？

### 方案 1: 上报到后端接口（推荐）

**优点：**
- 数据完全可控
- 可以自定义分析逻辑
- 数据安全，不外泄

**实现方式：**
1. 后端提供埋点接口：`POST /api/tracking/events`
2. 前端调用接口上报数据
3. 后端存储到数据库

### 方案 2: 上报到 Supabase

**优点：**
- 使用现有的 Supabase 基础设施
- 可以快速搭建
- 支持实时查询

**实现方式：**
1. 在 Supabase 创建 `events` 表
2. 前端通过 Supabase Client 插入数据
3. 通过 Supabase Dashboard 查看数据

### 方案 3: 第三方统计平台

**优点：**
- 现成的分析工具
- 可视化报表
- 无需自己开发

**缺点：**
- 数据在第三方平台
- 可能有隐私问题
- 需要付费（部分平台）

**常见平台：**
- Google Analytics
- Firebase Analytics
- Mixpanel
- Amplitude

## 三、推荐实现方案

根据你的项目情况，推荐使用**方案 1（后端接口）**：

1. **数据安全**：数据存储在自己的服务器
2. **灵活分析**：可以自定义分析逻辑
3. **成本可控**：不需要第三方服务费用
4. **符合文档要求**：文档中提到"自建埋点接口"

## 四、实现步骤

### 步骤 1: 后端提供埋点接口

后端需要提供一个接口接收埋点数据：

```
POST /api/tracking/events
Content-Type: application/json
Authorization: Bearer {token}  // 可选，如果用户已登录

Body: {
  "event_id": "xxx",
  "event_name": "page_view_login",
  "event_time": 1234567890,
  "user_id": "user_123",
  "device_id": "device_456",
  "platform": "android",
  "app_version": "1.0.0",
  ...
}
```

### 步骤 2: 前端实现上报逻辑

在 `services/tracking/index.ts` 中实现 `sendTrackingEvent` 函数，调用后端接口。

### 步骤 3: 批量上报优化

为了提高性能，可以实现批量上报：
- 将多个事件缓存到本地
- 定时批量发送（如每 10 秒或累积 10 条）
- 减少网络请求次数

### 步骤 4: 离线缓存

如果网络不可用，可以将埋点数据缓存到本地：
- 使用 AsyncStorage 存储
- 网络恢复后自动上报
- 避免数据丢失

## 五、当前代码状态

### ✅ 已完成
- 埋点服务框架
- 自动补全公共字段
- 调试模式（开发环境打印）

### ⏳ 待实现
- 实际上报逻辑（调用后端接口）
- 批量上报
- 离线缓存
- 错误重试

## 六、下一步

1. **确认后端接口**：与后端确认埋点接口地址和格式
2. **实现上报逻辑**：在 `sendTrackingEvent` 中调用后端接口
3. **测试验证**：确保生产环境能正常上报
4. **数据分析**：后端存储数据后，可以通过 SQL 查询或数据分析工具查看

